#!/bin/bash
# The MIT License
# Copyright (c) 2020-2027 Isamu.Yamauchi , 2022.5.5 update 2022.5.6
# Scan GPIO IAQ & LED Display for ubuntu.
# pepoiaq2led
# Connect physical Pin 2 ->Red Led, Pin 3 ->Green Led
DIR=/www/remote-hand/tmp
GPIORD=$DIR/.gpiodi_read_data
GPIOWD=$DIR/.do_write_cp2112_helper
DEEP=3000
LIGHT=1500
DSLEEP="/usr/local/bin/msleep $DEEP"
LSLEEP="/usr/local/bin/msleep $LIGHT"
GPIOCTL_DO="/usr/local/bin/pepocp2112ctl"
GREEN="$GPIOCTL_DO 3 1"
RED="$GPIOCTL_DO 2 1"
BLACK="$GPIOCTL_DO 2 0; $GPIOCTL_DO 3 0"
YELLOW="$GREEN ;$RED"

while true;do
  if [ -e $GPIORD ];then
    if [ -e $GPIOWD ];then
      . $GPIOWD
    else
      DO[0]=0
      DO[1]=0
    fi
    while true;do
      IAQ=`cat $GPIORD|awk 'BEGIN{FS=","};{printf $6}'`
      [ ! -z "$IAQ" ] && break
      $DSLEEP
    done
    IAQ_COLOR=$GREEN
    if [ $IAQ -lt 51 ];then
      IAQ_COLOR=$GREEN
    elif [ $IAQ -lt 101 ];then
      IAQ_COLOR=$GREEN
    elif [ $IAQ -lt 151 ];then
      IAQ_COLOR=$YELLOW
    elif [ $IAQ -lt 201 ];then
      IAQ_COLOR=$YELLOW
    elif [ $IAQ -lt 301 ];then
      IAQ_COLOR=$RED
    else
      IAQ_COLOR=$RED
    fi
    $IAQ_COLOR >/dev/null 2>&1
    $LSLEEP
    $BLACK >/dev/null 2>&1
  fi
  $DSLEEP
done

#!/bin/bash
# The MIT License
# Copyright (c) 2021-2028 Isamu.Yamauchi , 2026.2.10 update 2026.2.11
# Control RP2040-Zero for i386.
# peporp2040rwctld
WAIT=100
DIO_DEV=/dev/ttyACM0
LOOPSLEEP=1000
LOOPDOCT=2
LOOPI2CT=20
LOOPI2CT_BME680=2
BASECT=50
GAS_BASECONST=3000000
ADC_CT=16
ADC_CT_MIN=14
EPOCHOLD=`date -ud "0 second ago" +%s`
EPOC5MIN=300
gpio_i2c="-1"
DATEjitter=2
RETRY=2
DIOCT=2
DIR=/www/remote-hand/tmp
GPIORD=$DIR/.gpiodi_read_data
tGPIORD=$DIR/.gpiodi_read_data.tmp
GPIOWD=$DIR/.gpiodo_write_data
tGPIOWD=$DIR/.gpiodo_write_data.tmp
DOWDHELP=$DIR/.do_write_rp2040_helper
ALIAS_DI=$DIR/.alias_di
tALIAS_DI=$DIR/.alias_di_peporp2040rwctld
TCOSRD=$DIR/.tocos_read_data
tTCOSRD=$DIR/.tocos_read_tmp_peporp2040rwctld
GPIO_INIT_FLAG="YES"
ISLIVEBME680="NO"
BME680_RD=$DIR/.peporp2040bme680
BME680_CT_MIN=42
GPIOCTL_I2CBME680="/usr/local/bin/peporp2040rwctl i2c 45 $WAIT"
GPIOCTL_IN="/usr/local/bin/peporp2040rwctl dob,0 2 $WAIT"
GPIOCTL_ADC="/usr/local/bin/peporp2040rwctl adc $ADC_CT $WAIT"
GPIOCTL="/usr/local/bin/peporp2040rwctl"
GPIOCTL_DU="/usr/local/bin/peporp2040rwctl DUMMY"
error(){
  [ -e $tGPIORD ] && rm -f $tGPIORD
  [ -e $GPIORD ] && rm -f $GPIORD
  [ -e $GPIOWD ] && rm -f $GPIOWD
  [ -e $BME680_RD ] && rm -f $BME680_RD
  [ -e $TCOSRD ] && rm -f $TCOSRD
  [ -e $tTCOSRD ] && rm -f $tTCOSRD
  exit 0
}
while true;do
  [ -e $ALIAS_DI ] && . $ALIAS_DI
  if [ "$DI_TTY" != "rp2040" ];then
    GPIO_INIT_FLAG="YES"
    LOOPTIME=$LOOPSLEEP
    msleep $LOOPTIME
    continue
  elif [ "$DI_TTY" = "rp2040" ];then
    break
  fi
done
# BME680 keep alive seconds
BME680_ALIVE=30
trap error TERM HUP KILL INT QUIT
[ -e $tGPIORD ] && rm -f $tGPIORD
[ -e $GPIORD ] && rm -f $GPIORD
[ -e $GPIOWD ] && rm -f $GPIOWD
[ -e $tGPIOWD ] && rm -f $tGPIOWD
[ -e $TCOSRD ] && rm -f $TCOSRD
[ -e $tTCOSRD ] && rm -f $tTCOSRD
LOOPDO=${LOOPDOCT}
LOOPI2C=${LOOPI2CT}
ISLIVEBME680="YES"
i=0
while [ $i -lt $BASECT ];do
  GAS[$i]=0
  tGAS[$i]=0
  i=$(($i + 1))
done
GAS[$i]=0
while true;do
  unset DI_TTY
  [ -e $ALIAS_DI ] && . $ALIAS_DI
  if [ "$DI_TTY" = "none" ];then
    GPIO_INIT_FLAG="YES"
    LOOPTIME=$LOOPSLEEP
    msleep $LOOPTIME
    continue
  fi
  if [ "$DI_TTY" != "rp2040" ];then
    LOOPTIME=$LOOPSLEEP
    msleep $LOOPTIME
    continue
  elif [ "$DI_TTY" = "rp2040" ];then
    LOOPTIME=$LOOPSLEEP
    msleep $LOOPTIME    
    [ ! -e $DIO_DEV ] && continue
  fi
  svc -d /www/pepolinux/tocosd
  retry(){
    TRY=$RETRY
    while [ $TRY -ne 0 ];do
      retry_time=`echo -en "${RANDOM}" |cut -c 1-3`
      msleep $retry_time
      TMP=`$GPIOCTL_DU 2>&1`
      if [ "$TMP" = "-1" ];then
        break
      else
        msleep $retry_time
        TRY=$(($TRY - 1))
      fi
    done
  }
  adc_read(){
    # ADC read
    ADC=`$GPIOCTL_ADC 2>&1`
    LEN=`echo -en $ADC| wc -c`
    if [ $LEN -lt $ADC_CT_MIN -o $ADC = "-1" ];then
      retry
      ADC=`$GPIOCTL_ADC 2>&1`
      LEN=`echo -en $ADC| wc -c`
    fi
    [ $LEN -lt $ADC_CT_MIN -o $ADC = "-1" ] && return
    VAI4=`echo ${ADC}|awk '{split($0,I,":");printf I[2]}'`
    [[ "$VAI4" =~ ^[0-9]+$ ]] || return
    if [ -n "${slice_ai[15]}" ];then
      [ "${VAI4}" -lt "${slice_ai[15]}" ] && AI4="0" || AI4="1"
    fi
    if [ -e $TCOSRD ];then
      cat $TCOSRD |grep -v "VAI4" |grep -v "AI4" > $tTCOSRD
      cat >>$tTCOSRD<<END
AI4=$AI4
VAI4=$VAI4
END
    else
      cat >$tTCOSRD<<END
AI4=$AI4
VAI4=$VAI4
END
    fi
    mv $tTCOSRD $TCOSRD
  }

  unset piface_ip di do DO
  for i in 0 1 2 3 4 5 6 7; do old[$i]="-1" ;done
  LOOPTIME=$LOOPSLEEP
  # usb gpio_do initialize
  if [ $GPIO_INIT_FLAG = "YES" ];then
    NOW=$(($(date +%s) + $DATEjitter))
    NOW="dt"$NOW
    RD=`$GPIOCTL $NOW 2>&1` ; [ "$RD" != "-1" ] && GPIO_INIT_FLAG="NO" || GPIO_INIT_FLAG="YES"
    msleep $WAIT
    RD=`$GPIOCTL_DU 2>&1` ; [ "$RD" != "-1" ] && GPIO_INIT_FLAG="NO" || GPIO_INIT_FLAG="NO"
    msleep $WAIT
    RD=`$GPIOCTL_IN 2>&1` ; [ "$RD" != "-1" ] && GPIO_INIT_FLAG="NO" || GPIO_INIT_FLAG="YES"
    msleep $WAIT
    adc_read
    msleep $WAIT
    RD=`$GPIOCTL_I2CBME680 2>&1` ; [ "$RD" != "-1" ] && ISLIVEBME680="NO" || ISLIVEBME680="YES"
    LEN=$(echo -en $RD| wc -c)
    [ $LEN -lt $BME680_CT_MIN ] && RD="-1" || LOOPI2C=0
    [ $RD != "-1" ] && echo -n $RD >$BME680_RD || rm $BME680_RD
  fi
  #DO write
  if [ -e $DOWDHELP ];then
    if [ $LOOPDO = 0 ];then
      LOOPDO=${LOOPDOCT}
      unset DO
      . $DOWDHELP
      BDO=0
      for i in 0 1 2 3; do
      if [ ! -z ${DO[$i]} ];then
        case "$i" in
          0) BDO=$((${DO[i]} * 1 + $BDO)) ;;
          1) BDO=$((${DO[i]} * 2 + $BDO)) ;;
          2) BDO=$((${DO[i]} * 4 + $BDO)) ;;
          3) BDO=$((${DO[i]} * 8 + $BDO)) ;;
        esac
      fi
      done
      RD=`$GPIOCTL dob,$(printf %x $BDO) 2 $WAIT 2>&1`
    else
      LOOPDO=$(($LOOPDO - 1))
    fi
  fi
  if [ $LOOPI2C = 0 ];then
    adc_read
    ISLIVEBME680="NO"
    LOOPI2C=$LOOPI2CT
    RD=`$GPIOCTL_I2CBME680 2>&1` ; [ "$RD" != "-1" ] && ISLIVEBME680="NO" || ISLIVEBME680="YES"
    LEN=$(echo -en $RD| wc -c)
    [ $LEN -lt $BME680_CT_MIN ] && RD="-1"
    [ $RD != "-1" ] && echo -n $RD >$BME680_RD || rm $BME680_RD
    if [ $RD != "-1" ];then
      echo -n $RD >$BME680_RD
    fi
    if [ -e $BME680_RD ];then
      if [ $(($(date "+%s") - $(date "+%s" -r $BME680_RD))) -gt 10 ];then
        rm $BME680_RD
      else
        if [ $(cat $BME680_RD| wc -c) -lt 20 ];then
          rm $BME680_RD
        fi
      fi
    fi
    if [ -e $BME680_RD ];then
      LOOPI2C=$LOOPI2CT_BME680
      gpio_i2c=`cat $BME680_RD | mawk 'BEGIN{FS=","};{split($1,I,"/");split($4,J,".");printf("%s,%s,%s,%s,%s",I[4],$2,$3,J[1],$5)}'`
      BME680TEMP=`cat $BME680_RD | mawk 'BEGIN{FS=","};{printf("%s",$2)}'`
      BME680TEMP=`echo -en $BME680TEMP | mawk 'BEGIN{FS="."};{printf("%s",$1)}'`
      BME680HUM=`cat $BME680_RD | mawk 'BEGIN{FS=","};{printf("%s",$3)}'`
      BME680HUM=`echo -en $BME680HUM | mawk 'BEGIN{FS="."};{printf("%s",$1)}'`
      BME680GAS=`cat $BME680_RD | mawk 'BEGIN{FS=","};{printf("%s",$5)}'`
      BME680GAS=`echo -en $BME680GAS | mawk 'BEGIN{FS="."};{printf("%s",$1)}'`
      HUM_BASELOW=40
      HUM_BASEHIGH=70
      HUM_SCORE=0
      TEMP_BASELOW=17
      TEMP_BASEHIGH=28
      TEMP_SCORE=0
      GAS_SCORE=0
      HUM_WEIGHT=10
      HUM_WEIGHT=$(($HUM_WEIGHT * 5))
      TEMP_WEIGHT=10
      TEMP_WEIGHT=$(($TEMP_WEIGHT * 5))
      GAS_WEIGHT=80
      GAS_WEIGHT=$(($GAS_WEIGHT * 5))
      GAS_BASE_CONF=${slice_ai[24]}
      GAS_BASE_AUTO_FIX=${slice_ai[25]}
      [ -z $GAS_BASE_AUTO_FIX ] && GAS_BASE_AUTO_FIX="Auto"
      if [ ! -z $GAS_BASE_CONF ];then
        GAS_BASE=$GAS_BASE_CONF
      else
        GAS_BASE=$GAS_BASECONST
      fi
      EPOCHNOW=`date -ud "0 second ago" +%s`
      if [ $(($EPOCHNOW - $EPOCHOLD)) -gt $EPOC5MIN ];then
        EPOCHOLD=$EPOCHNOW
        i=0
        j=0
        GAS_SUM=0
        GAS[$i]=$BME680GAS
        while [ $i -lt $BASECT ];do
          GAS[$i]=$((${GAS[$i]} + 0))
          if [ ${GAS[$i]} -ne 0 ];then
            GAS_SUM=$(($GAS_SUM + ${GAS[$i]}))
            j=$(($j + 1))
            tGAS[$(($i + 1))]=${GAS[$i]}
            i=$(($i + 1))
          else
            break
          fi
        done
        i=1
        while [ $i -lt $BASECT ];do
          tGAS[$i]=$((${tGAS[$i]} + 0))
          if [ ${tGAS[$i]} -ne 0 ];then
            GAS[$i]=${tGAS[$i]}
            i=$(($i + 1))
          else
            break
          fi
        done
        if [ $j -eq $BASECT -a "$GAS_BASE_AUTO_FIX" = "Auto" ];then
          GAS_BASE=$(($GAS_SUM / $j))
          if [ -e $ALIAS_DI ];then
            cat $ALIAS_DI | grep -v "slice_ai\[24\]" >$tALIAS_DI
            echo "slice_ai[24]=$GAS_BASE" >> $tALIAS_DI
            chown www-data:www-data $tALIAS_DI
            mv $tALIAS_DI $ALIAS_DI
          fi
        fi
      fi
      if [ $BME680TEMP -gt $TEMP_BASEHIGH ];then
        TEMP_OFFSET=$(($BME680TEMP - $TEMP_BASEHIGH))
        TEMP_SCORE=$(($(($TEMP_OFFSET * $TEMP_WEIGHT)) / $((50 - $TEMP_BASEHIGH))))
      elif [ $BME680TEMP -lt $TEMP_BASELOW ];then
        TEMP_OFFSET=$(($TEMP_BASELOW - $BME680TEMP))
        TEMP_SCORE=$(($(($TEMP_OFFSET * $TEMP_WEIGHT)) / $TEMP_BASELOW))
      fi
      if [ $BME680HUM -gt $HUM_BASEHIGH ];then
        HUM_OFFSET=$(($BME680HUM - $HUM_BASEHIGH))
        HUM_SCORE=$(($(($HUM_OFFSET * $HUM_WEIGHT)) / $((100 - $HUM_BASEHIGH))))
      elif [ $BME680HUM -lt $HUM_BASELOW ];then
        HUM_OFFSET=$(($HUM_BASELOW - $BME680HUM))
        HUM_SCORE=$(($(($HUM_OFFSET * $HUM_WEIGHT)) / $HUM_BASELOW))
      fi
      if [ $BME680GAS -gt $GAS_BASE ];then
        GAS_OFFSET=$(($BME680GAS - $GAS_BASE))
        GAS_SCORE=$(($(($GAS_OFFSET * $GAS_WEIGHT)) / $GAS_BASE))
      else
        GAS_OFFSET=$(($GAS_BASE - $BME680GAS))
        GAS_SCORE=$(($(($GAS_OFFSET * $GAS_WEIGHT)) / $GAS_BASE))
      fi
      IAQ=$(($TEMP_SCORE + $HUM_SCORE + $GAS_SCORE))
      [ $IAQ -gt 500 ] && IAQ=500
      gpio_i2c=`echo -en $gpio_i2c,$IAQ`
    else
      if [ ! -z $EPOCHNOW ];then
        tEPOCHNOW=$(date -ud "0 second ago" +%s)
        if [ $(($tEPOCHNOW - $EPOCHNOW)) -gt $BME680_ALIVE ];then
          RD=`$GPIOCTL_I2CBME680 2>&1`
          LEN=$(echo -en $RD| wc -c)
          [ $LEN -lt $BME680_CT_MIN ] && RD="-1"
          [ $RD != "-1" ] && echo -n $RD >$BME680_RD || rm $BME680_RD
        fi
      fi
    fi
  else
    LOOPI2C=$(($LOOPI2C - 1))
  fi
  RD=`$GPIOCTL diob 2 $WAIT 2>&1`
  LEN=`echo $RD|mawk '{print(length($0))}'`
  if [ $LEN != $DIOCT ];then
    retry
    RD=`$GPIOCTL diob 2 $WAIT 2>&1`
    LEN=`echo $RD|mawk '{print(length($0))}'`
    [ $LEN != $DIOCT ] && RD="-1"
  fi
  LEN=`echo $RD|mawk '{print(length($0))}'`
  if [ "$RD" != "-1" -o "LEN" = 2 ];then
    GPIO_INIT_FLAG="NO"
    for i in 1 2 4 8 16 32 64 128; do
      case "$i" in
        1) tRD="$(($((0x$RD & 1)) / 1))" ;j=0 ;;
        2) tRD="$(($((0x$RD & 2)) / 2))" ;j=1 ;;
        4) tRD="$(($((0x$RD & 4)) / 4))" ;j=2 ;;
        8) tRD="$(($((0x$RD & 8)) / 8))" ;j=3 ;;
        16) tRD="$(($((0x$RD & 16)) / 16))" ;j=4 ;;
        32) tRD="$(($((0x$RD & 32)) / 32))" ;j=5 ;;
        64) tRD="$(($((0x$RD & 64)) / 64))" ;j=6 ;;
        128) tRD="$(($((0x$RD & 128)) / 128))" ;j=7 ;;
      esac
    old[$j]=$tRD
    done
    cat>$tGPIORD<<END
di[0]=${old[0]}
di[1]=${old[1]}
di[2]=${old[2]}
di[3]=${old[3]}
gpio_i2c=${gpio_i2c}
END
    cat>$tGPIOWD<<END
do[0]=${old[4]}
do[1]=${old[5]}
do[2]=${old[6]}
do[3]=${old[7]}
END
    chown www-data:www-data $tGPIORD $tGPIOWD
    mv $tGPIORD $GPIORD ; mv $tGPIOWD $GPIOWD
  fi
  msleep $LOOPTIME
done
